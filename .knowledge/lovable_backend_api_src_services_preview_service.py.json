{"is_source_file": true, "format": "Python", "description": "This file defines a PreviewService class for managing WebSocket connections and file previews for projects. It handles registration, unregistration, file retrieval, and broadcasting reload events to connected clients, utilizing asyncio for concurrency control.", "external_files": ["src.services.project_files_service"], "external_methods": ["project_files_service.list_files"], "published": ["preview_service"], "classes": [{"name": "ProjectPreviewState", "description": "Holds websocket connections for a project's live preview."}, {"name": "PreviewService", "description": "Service to serve static content from project files and broadcast reloads over WebSocket."}], "methods": [{"name": "Optional[FileRecord] read_file(self, owner_email: str, project_id: str, path: str)", "description": "Returns a file by web path for preview, normalizing the path.", "scope": "PreviewService", "scopeKind": "class"}, {"name": "None register_ws(self, owner_email: str, project_id: str, ws: WebSocket)", "description": "Registers a WebSocket connection for a project's preview reload channel.", "scope": "PreviewService", "scopeKind": "class"}, {"name": "None unregister_ws(self, owner_email: str, project_id: str, ws: WebSocket)", "description": "Unregisters a WebSocket connection.", "scope": "PreviewService", "scopeKind": "class"}, {"name": "None broadcast_reload(self, owner_email: str, project_id: str, reason: str = \"file_change\")", "description": "Broadcasts a reload event to all connected WebSocket clients for a project.", "scope": "PreviewService", "scopeKind": "class"}, {"name": "ProjectPreviewState _get_state(self, owner_email: str, project_id: str)", "description": "Internal method to retrieve or create the state associated with a project's WebSocket connections.", "scope": "PreviewService", "scopeKind": "class"}, {"name": "tuple[str,str] _key(self, owner_email: str, project_id: str)", "description": "Internal method to generate a unique key for a project based on owner email and project ID.", "scope": "PreviewService", "scopeKind": "class"}, {"name": "None __init__(self)", "scope": "PreviewService", "scopeKind": "class", "description": "unavailable"}], "calls": ["project_files_service.list_files", "ws.send_text"], "search-terms": ["PreviewService", "broadcast_reload", "WebSocket connections", "project preview", "file retrieval", "asyncio.Lock", "live preview websocket"], "state": 2, "file_id": 17, "knowledge_revision": 44, "git_revision": "", "ctags": [{"_type": "tag", "name": "PreviewService", "path": "/home/kavia/workspace/code-generation/appbuilder-pro-222032-222043/lovable_backend_api/src/services/preview_service.py", "pattern": "/^class PreviewService:$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "ProjectPreviewState", "path": "/home/kavia/workspace/code-generation/appbuilder-pro-222032-222043/lovable_backend_api/src/services/preview_service.py", "pattern": "/^class ProjectPreviewState:$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "__init__", "path": "/home/kavia/workspace/code-generation/appbuilder-pro-222032-222043/lovable_backend_api/src/services/preview_service.py", "pattern": "/^    def __init__(self) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "member", "signature": "(self)", "scope": "PreviewService", "scopeKind": "class"}, {"_type": "tag", "name": "_get_state", "path": "/home/kavia/workspace/code-generation/appbuilder-pro-222032-222043/lovable_backend_api/src/services/preview_service.py", "pattern": "/^    def _get_state(self, owner_email: str, project_id: str) -> ProjectPreviewState:$/", "language": "Python", "typeref": "typename:ProjectPreviewState", "kind": "member", "signature": "(self, owner_email: str, project_id: str)", "scope": "PreviewService", "scopeKind": "class"}, {"_type": "tag", "name": "_key", "path": "/home/kavia/workspace/code-generation/appbuilder-pro-222032-222043/lovable_backend_api/src/services/preview_service.py", "pattern": "/^    def _key(self, owner_email: str, project_id: str) -> tuple[str, str]:$/", "language": "Python", "typeref": "typename:tuple[str,str]", "kind": "member", "signature": "(self, owner_email: str, project_id: str)", "scope": "PreviewService", "scopeKind": "class"}, {"_type": "tag", "name": "broadcast_reload", "path": "/home/kavia/workspace/code-generation/appbuilder-pro-222032-222043/lovable_backend_api/src/services/preview_service.py", "pattern": "/^    async def broadcast_reload(self, owner_email: str, project_id: str, reason: str = \"file_chan/", "language": "Python", "typeref": "typename:None", "kind": "member", "signature": "(self, owner_email: str, project_id: str, reason: str = \"file_change\")", "scope": "PreviewService", "scopeKind": "class"}, {"_type": "tag", "name": "preview_service", "path": "/home/kavia/workspace/code-generation/appbuilder-pro-222032-222043/lovable_backend_api/src/services/preview_service.py", "pattern": "/^preview_service = PreviewService()$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "read_file", "path": "/home/kavia/workspace/code-generation/appbuilder-pro-222032-222043/lovable_backend_api/src/services/preview_service.py", "pattern": "/^    def read_file(self, owner_email: str, project_id: str, path: str) -> Optional[FileRecord]:$/", "language": "Python", "typeref": "typename:Optional[FileRecord]", "kind": "member", "signature": "(self, owner_email: str, project_id: str, path: str)", "scope": "PreviewService", "scopeKind": "class"}, {"_type": "tag", "name": "register_ws", "path": "/home/kavia/workspace/code-generation/appbuilder-pro-222032-222043/lovable_backend_api/src/services/preview_service.py", "pattern": "/^    async def register_ws(self, owner_email: str, project_id: str, ws: WebSocket) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "member", "signature": "(self, owner_email: str, project_id: str, ws: WebSocket)", "scope": "PreviewService", "scopeKind": "class"}, {"_type": "tag", "name": "sockets", "path": "/home/kavia/workspace/code-generation/appbuilder-pro-222032-222043/lovable_backend_api/src/services/preview_service.py", "pattern": "/^    sockets: Set[WebSocket] = field(default_factory=set)$/", "language": "Python", "typeref": "typename:Set[WebSocket]", "kind": "variable", "scope": "ProjectPreviewState", "scopeKind": "class"}, {"_type": "tag", "name": "unregister_ws", "path": "/home/kavia/workspace/code-generation/appbuilder-pro-222032-222043/lovable_backend_api/src/services/preview_service.py", "pattern": "/^    async def unregister_ws(self, owner_email: str, project_id: str, ws: WebSocket) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "member", "signature": "(self, owner_email: str, project_id: str, ws: WebSocket)", "scope": "PreviewService", "scopeKind": "class"}], "hash": "c697bce218cc7e02c5ad6b228a5d1440", "format-version": 4, "code-base-name": "lovable_backend_api", "filename": "lovable_backend_api/src/services/preview_service.py", "fields": [{"name": "preview_service = PreviewService()", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "Set[WebSocket] sockets", "scope": "ProjectPreviewState", "scopeKind": "class", "description": "unavailable"}], "revision_history": [{"44": ""}]}